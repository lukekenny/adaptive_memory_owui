# Docker Compose for Real OpenWebUI Integration Testing
version: '3.8'

services:
  openwebui-test:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui-test
    ports:
      - "3000:8080"
    environment:
      - OPENWEBUI_SECRET_KEY=test-secret-key
      - WEBUI_AUTH=false  # Disable auth for testing
      - DATABASE_URL=sqlite:///test.db
    volumes:
      - ./adaptive_memory_v4.0.py:/app/backend/data/functions/adaptive_memory_v4.0.py
      - ./test_data:/app/backend/data
    command: ["python", "-m", "open_webui.main"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/auths"]
      interval: 30s
      timeout: 10s
      retries: 5

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    depends_on:
      openwebui-test:
        condition: service_healthy
    environment:
      - OPENWEBUI_BASE_URL=http://openwebui-test:8080
    volumes:
      - .:/workspace
    command: ["python", "-m", "pytest", "tests/integration/test_real_openwebui.py", "-v"]

networks:
  default:
    name: openwebui-test-network